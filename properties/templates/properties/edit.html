{% extends 'base.html' %}
{% load humanize %}

{% block title %}Edit: {{ property.title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="">
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Page Header -->
    <div class="mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'properties:my_properties' %}" class="text-decoration-none">My Properties</a></li>
                <li class="breadcrumb-item"><a href="{% url 'properties:detail' pk=property.pk %}" class="text-decoration-none">{{ property.title|truncatewords:4 }}</a></li>
                <li class="breadcrumb-item active" aria-current="page">Edit</li>
            </ol>
        </nav>
        <h1 class="h2 fw-bold">
            <i class="bi bi-pencil-square me-2"></i>Edit Property
        </h1>
        <p class="text-muted">Update the details of your property listing.</p>
    </div>

    <form method="post" enctype="multipart/form-data" novalidate>
        {% csrf_token %}

        <div class="row g-4">
            <div class="col-lg-8">
                <!-- Basic Information -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-info-circle me-2"></i>Basic Information
                        </h5>
                    </div>
                    <div class="card-body">
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                            <p class="mb-0">{{ error }}</p>
                            {% endfor %}
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label fw-semibold">Title <span class="text-danger">*</span></label>
                            {{ form.title }}
                            {% if form.title.errors %}
                            <div class="invalid-feedback d-block">{{ form.title.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="{{ form.property_type.id_for_label }}" class="form-label fw-semibold">Property Type <span class="text-danger">*</span></label>
                                {{ form.property_type }}
                                {% if form.property_type.errors %}
                                <div class="invalid-feedback d-block">{{ form.property_type.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.rental_purpose.id_for_label }}" class="form-label fw-semibold">Rental Purpose</label>
                                {{ form.rental_purpose }}
                                {% if form.rental_purpose.errors %}
                                <div class="invalid-feedback d-block">{{ form.rental_purpose.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">Status <span class="text-danger">*</span></label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <div class="invalid-feedback d-block">{{ form.status.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold">Description <span class="text-danger">*</span></label>
                            {{ form.description }}
                            {% if form.description.errors %}
                            <div class="invalid-feedback d-block">{{ form.description.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Location Details -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-geo-alt me-2"></i>Location Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="{{ form.district.id_for_label }}" class="form-label fw-semibold">District <span class="text-danger">*</span></label>
                                {{ form.district }}
                                {% if form.district.errors %}
                                <div class="invalid-feedback d-block">{{ form.district.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.municipality.id_for_label }}" class="form-label fw-semibold">Municipality</label>
                                {{ form.municipality }}
                                {% if form.municipality.errors %}
                                <div class="invalid-feedback d-block">{{ form.municipality.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4">
                                <label for="{{ form.ward_number.id_for_label }}" class="form-label fw-semibold">Ward Number <span class="text-danger">*</span></label>
                                {{ form.ward_number }}
                                {% if form.ward_number.errors %}
                                <div class="invalid-feedback d-block">{{ form.ward_number.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.address.id_for_label }}" class="form-label fw-semibold">Full Address <span class="text-danger">*</span></label>
                            {{ form.address }}
                            {% if form.address.errors %}
                            <div class="invalid-feedback d-block">{{ form.address.errors.0 }}</div>
                            {% endif %}
                        </div>

                        <!-- Map Coordinates -->
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.latitude.id_for_label }}" class="form-label fw-semibold">Latitude</label>
                                {{ form.latitude }}
                                {% if form.latitude.errors %}
                                <div class="invalid-feedback d-block">{{ form.latitude.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.longitude.id_for_label }}" class="form-label fw-semibold">Longitude</label>
                                {{ form.longitude }}
                                {% if form.longitude.errors %}
                                <div class="invalid-feedback d-block">{{ form.longitude.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div id="location-map" class="border rounded mb-2" style="height: 300px; background: #f8f9fa;">
                            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                                <div class="text-center">
                                    <i class="bi bi-map" style="font-size: 2rem;"></i>
                                    <p class="small mb-0 mt-1">Click on the map to set coordinates</p>
                                </div>
                            </div>
                        </div>
                        <div class="form-text">Click on the map to automatically fill latitude and longitude, or enter them manually.</div>
                    </div>
                </div>

                <!-- Pricing and Rooms -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-cash-stack me-2"></i>Pricing & Rooms
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="{{ form.price.id_for_label }}" class="form-label fw-semibold">Monthly Rent (NPR) <span class="text-danger">*</span></label>
                                {{ form.price }}
                                {% if form.price.errors %}
                                <div class="invalid-feedback d-block">{{ form.price.errors.0 }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6">
                                <label for="{{ form.num_rooms.id_for_label }}" class="form-label fw-semibold">Number of Rooms</label>
                                {{ form.num_rooms }}
                                {% if form.num_rooms.errors %}
                                <div class="invalid-feedback d-block">{{ form.num_rooms.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Amenities -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-check2-square me-2"></i>Amenities
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted small mb-3">Select all amenities available at this property.</p>
                        <div class="row">
                            {% for checkbox in form.amenities %}
                            <div class="col-6 col-md-4 col-lg-3 mb-2">
                                <div class="form-check">
                                    {{ checkbox }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% if form.amenities.errors %}
                        <div class="invalid-feedback d-block">{{ form.amenities.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <!-- Existing Images -->
                {% if property.images.all %}
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-images me-2"></i>Current Images
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row g-3">
                            {% for image in property.images.all %}
                            <div class="col-6 col-md-4">
                                <div class="position-relative border rounded overflow-hidden">
                                    <img src="{{ image.image.url }}"
                                         class="w-100"
                                         style="height: 150px; object-fit: cover;"
                                         alt="{{ image.caption|default:'Property image' }}">
                                    {% if image.is_primary %}
                                    <span class="position-absolute bottom-0 start-0 m-1 badge bg-success">Primary</span>
                                    {% endif %}
                                    {% if image.caption %}
                                    <div class="p-1 bg-light">
                                        <small class="text-muted">{{ image.caption }}</small>
                                    </div>
                                    {% endif %}
                                    <!-- Delete Image Button -->
                                    <form method="post" action="{% url 'properties:image_delete' pk=image.pk %}"
                                          class="position-absolute top-0 end-0 m-1"
                                          onsubmit="return confirm('Are you sure you want to delete this image?');">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-danger btn-sm rounded-circle shadow-sm"
                                                title="Delete this image">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <div class="col-lg-4">
                <!-- Contact Information -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-telephone me-2"></i>Contact Info
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="{{ form.contact_phone.id_for_label }}" class="form-label fw-semibold">Phone Number</label>
                            {{ form.contact_phone }}
                            {% if form.contact_phone.errors %}
                            <div class="invalid-feedback d-block">{{ form.contact_phone.errors.0 }}</div>
                            {% endif %}
                        </div>
                        <div class="mb-3">
                            <label for="{{ form.contact_email.id_for_label }}" class="form-label fw-semibold">Email Address</label>
                            {{ form.contact_email }}
                            {% if form.contact_email.errors %}
                            <div class="invalid-feedback d-block">{{ form.contact_email.errors.0 }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Add New Images -->
                <div class="card shadow-sm border-0 mb-4">
                    <div class="card-header bg-white border-bottom">
                        <h5 class="card-title fw-bold mb-0">
                            <i class="bi bi-cloud-upload me-2"></i>Add New Images
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="id_images" class="form-label fw-semibold">Upload Images</label>
                            <input type="file" class="form-control" id="id_images" name="images" multiple accept="image/*">
                            <div class="form-text">You can select multiple images to add to this property.</div>
                        </div>
                    </div>
                </div>

                <!-- Submit Actions -->
                <div class="card shadow-sm border-0">
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="bi bi-check-circle me-2"></i>Save Changes
                            </button>
                            <a href="{% url 'properties:detail' pk=property.pk %}" class="btn btn-outline-secondary">
                                <i class="bi bi-x-circle me-2"></i>Cancel
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
(function() {
    var mapDiv = document.getElementById('location-map');
    var latInput = document.getElementById('id_latitude');
    var lngInput = document.getElementById('id_longitude');
    if (!mapDiv || !latInput || !lngInput) return;

    // Clear the placeholder content
    mapDiv.innerHTML = '';

    var defaultLat = parseFloat(latInput.value) || 27.7172;
    var defaultLng = parseFloat(lngInput.value) || 85.3240;
    var defaultZoom = (latInput.value && lngInput.value) ? 15 : 13;

    var map = L.map(mapDiv).setView([defaultLat, defaultLng], defaultZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
        maxZoom: 19,
    }).addTo(map);

    var marker = null;

    function placeMarker(lat, lng) {
        if (marker) {
            marker.setLatLng([lat, lng]);
        } else {
            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            marker.on('dragend', function() {
                var pos = marker.getLatLng();
                latInput.value = pos.lat.toFixed(7);
                lngInput.value = pos.lng.toFixed(7);
            });
        }
        latInput.value = lat.toFixed(7);
        lngInput.value = lng.toFixed(7);
    }

    // Place initial marker if coordinates exist
    if (latInput.value && lngInput.value) {
        placeMarker(defaultLat, defaultLng);
    }

    // Click on map to place/move marker
    map.on('click', function(e) {
        placeMarker(e.latlng.lat, e.latlng.lng);
    });
})();
</script>
{% endblock %}
